# TIL 220329ARC

## ðŸ”¥í•™ìŠµ ë‚´ìš©
### ARC
- Swiftì—ì„œëŠ” ìžë™ ë©”ëª¨ë¦¬ íšŒìˆ˜ ê¸°ëŠ¥ì´ ì—†ìŒ.
- Stackì— ì €ìž¥ë˜ëŠ” ë°ì´í„°ëŠ” ìžë™ìœ¼ë¡œ ì œê±°ë˜ê¸° ë•Œë¬¸ì— íŠ¹ë³„í•œ ê´€ë¦¬ê°€ í•„ìš”í•˜ì§€ ì•ŠìŒ.
- í•˜ì§€ë§Œ Heapì— ì €ìž¥ë˜ëŠ” ë°ì´í„°ëŠ” í•„ìš”í•˜ì§€ ì•ŠëŠ” ì‹œì ì— ì§ì ‘ ê´€ë¦¬í•´ì¤˜ì•¼í•¨. (í´ëž˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ ì°¸ì¡° ê°’)
- Object-C ì—ì„œë¶€í„° ì‚¬ìš©ë˜ë˜ Referece Count ëª¨ë¸ì„ O-c 2.0 ë²„ì „ë¶€í„° ì»´íŒŒì¼ë‹¨ì—ì„œ ìžë™ìœ¼ë¡œ Retainê³¼ Release ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ëŠ” ARC ë©”ëª¨ë¦¬ ê´€ë¦¬ ì •ì±…ì„ ë„ìž…í•˜ê³  ì´ìš©í•´ì„œ ê´€ë¦¬.
- ì—¬ê¸°ì„œ O-c ì—ì„œëŠ” 2.0 ë²„ì „ ì „ê¹Œì§€ëŠ” ìˆ˜ë™ìœ¼ë¡œ RCë¥¼ í•´ì¤¬ì–´ì•¼ í–ˆëŠ”ë°, ì´ëŸ¬ë‹¤ë³´ë‹ˆ ìˆ˜ë™ì´ë¼ëŠ” ë‹¨ì–´ì˜ Manual + RC ë¼ê³  ë¶ˆë¦¬ë©´ì„œ MRCë¼ëŠ” ë‹¨ì–´ê°€ ë§Œë“¤ì–´ì§. 
- [Transitioning to ARC Release Notes](https://developer.apple.com/library/archive/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html) í•´ë‹¹ ë¬¸ì„œì—ì„œ ì„¤ëª…í•˜ëŠ” ë¶€ë¶„ì— Manual Reference Countingì´ë¼ê³  ì„¤ëª…ì„ í•˜ì§€ë§Œ, ì´ê±´ ë§ ê·¸ëŒ€ë¡œ ìˆ˜ë™ìœ¼ë¡œ retain-realse í•˜ëŠ” ê²ƒì„ ë§í•˜ëŠ” ê²ƒì´ê³  ê³µì‹ì ìœ¼ë¡œ MRCë¼ëŠ” ë©”ëª¨ë¦¬ ê´€ë¦¬ ì •ì±…ì€ ì—†ìŒ. ê·¸ëƒ¥ RCìž„.
- ê·¸ëž˜ì„œ ARC ì´ì „ì˜ ë©”ëª¨ë¦¬ ê´€ë¦¬ ë°©ì‹ì´ë¼ê³  í•œë‹¤ë©´, MRR(Manual Retain Release) ë°©ì‹ì´ë¼ê³  í•˜ëŠ”ê²Œ ë§žëŠ” ê²ƒ ê°™ìŒ(ë‡Œí”¼ì…œ)

```swift
class Person {
   var name = "ë§ˆì´ë…¸"
   
   deinit {
      print("person deinit")
   }
}

var person1: Person?
var person2: Person?
var person3: Person?

person1 = Person()
person2 = person1
person3 = person1 // í˜„ìž¬ Person Instanceì˜ ì°¸ì¡° ì¹´ìš´íŒ…ì€ 3
person1 = nil
person2 = nil // nilì„ ì €ìž¥í•˜ëŠ”ê²ƒì€ ì†Œìœ ê¶Œì„ í¬ê¸°í•˜ëŠ” ê²ƒê³¼ ê°™ìŒ. ì°¸ì¡° ì¹´ìš´íŒ…ì€ 1
person3 = nil // ì°¸ì¡° ì¹´ìš´íŒ…ì´ 0ì´ ë˜ë©´ì„œ ì œê±°ë˜ê³ , deinit í˜¸ì¶œ.
```

### Strong Reference Cycle
- ê°•í•œ ì°¸ì¡°ëž€ í”„ë¡œí¼í‹°, ìƒìˆ˜ ë˜ëŠ” ë³€ìˆ˜ì— í´ëž˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í• ë‹¹í•˜ëŠ” ê²ƒ
- ë³€ìˆ˜ì™€ ì¸ìŠ¤í„´ìŠ¤ê°„ì˜ ì°¸ì¡°ëŠ” ì‚¬ë¼ì¡Œì§€ë§Œ, ê° ì¸ìŠ¤í„´ìŠ¤ê°„ì˜ ì°¸ì¡°ê°€ ì—¬ì „ížˆ ë‚¨ì•„ìžˆì–´ì„œ ì°¸ì¡° ì¹´ìš´íŠ¸ê°€ 0ì´ ë  ìˆ˜ ì—†ì–´ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•  ë°©ë²•ì´ ì—†ì–´ì ¸ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•˜ëŠ” ìƒí™©
- ARCëŠ” ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ëŒ€ì‹  ì²˜ë¦¬í•´ì£¼ì§€ë§Œ, ì°¸ì¡° ì‹¸ì´í´ê¹Œì§€ ìžë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì§€ëŠ” ëª»í•¨
- ë”°ë¼ì„œ Weak Referenceì™€ Unowned Referenceë¥¼ í†µí•´ í•´ê²° -> ë‘ ë°©ì‹ ëª¨ë‘ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ì´ì— ê°•í•œ ì°¸ì¡°ë¥¼ ì œê±°í•˜ëŠ” ë°©ì‹
- Weak Referenceì™€ Unowned ReferenceëŠ” ê°•í•œ ì°¸ì¡°ì™€ëŠ” ë‹¬ë¦¬ ì°¸ì¡° ì¹´ìš´íŠ¸ë¥¼ ì¦ê°€ì‹œí‚¤ê±°ë‚˜ ê°ì†Œì‹œí‚¤ì§€ ì•ŠìŒ. ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼ í• ìˆ˜ëŠ” ìžˆì§€ë§Œ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ìœ ì§€í•˜ëŠ”ê²ƒì€ ë¶ˆê°€
- Weak ReferenceëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•˜ì§€ë§Œ, ì†Œìœ í•˜ì§€ëŠ” ì•ŠìŒ. ì´ëŸ° íŠ¹ì§•ìœ¼ë¡œ ì†Œìœ ìžì— ë¹„í•´ ì§§ì€ ìƒëª…ì£¼ê¸°ë¥¼ ê°€ì§„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©, ì˜µì…”ë„ì¸ ê²½ìš° Weak ì‚¬ìš©
- Unowned ReferenceëŠ” ì•½í•œ ì°¸ì¡°ì™€ ë™ì¼í•œ ë°©ì‹ì´ê³  Swift 5.0 ë¶€í„° ì˜µì…”ë„ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì´ ê°€ëŠ¥. í•˜ì§€ë§Œ ì°¸ì¡° ëŒ€ìƒì´ ì‚¬ë¼ì§„ ê²½ìš° ì§ì ‘ ì´ˆê¸°í™” í•˜ì§€ ì•Šìœ¼ë©´ í¬ëž˜ì‹œ. ì†Œìœ ìžì™€ ìƒëª…ì£¼ê¸°ê°€ ê°™ê±°ë‚˜ ë” ê¸´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©, ì˜µì…”ë„ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì€ ê°€ëŠ¥í•˜ì§€ë§Œ ì¼ë‹¨ì€ ì˜µì…”ë„ì´ ì•„ë‹ˆì–´ì•¼ë˜ëŠ” ê²½ìš°ì— ì‚¬ìš©í•œë‹¤ê³  ì´í•´í•˜ê¸°

```swift
// Strong Reference Cycle
class Person {
    var name = "ë§ˆì´ë…¸"
    var car: Car?
    
    deinit {
        print("person deinit")
    }
}

class Car {
    var model: String
    var lessee: Person?
    
    init(model: String) {
        self.model = model
    }
    
    deinit {
        print("car deinit")
    }
}

var person: Person? = Person()
var rentedCar: Car? = Car(model: "Porsche") // ì°¸ì¡° ì¹´ìš´íŠ¸ 1

person?.car = rentedCar
rentedCar?.lessee = person // ì°¸ì¡° ì¹´ìš´íŠ¸ 2

person = nil
rentedCar = nil 
// ë³€ìˆ˜ì™€ ì¸ìŠ¤í„´ìŠ¤ê°„ì˜ ì°¸ì¡°ëŠ” -1 release ë˜ì§€ë§Œ 
// ì¸ìŠ¤í„´ìŠ¤ê°„ì˜ ì°¸ì¡°ëŠ” releaseê°€ ë˜ì§€ì•ŠìŒ ë”°ë¼ì„œ ì°¸ì¡° ì¹´ìš´íŠ¸ 1 ì—¬ì „ížˆ ì°¸ì¡°ê°€ ë‚¨ì•„ìžˆìŒ. 
// ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°œìƒ.

// Weak Reference
class Person {
    var name = "ë§ˆì´ë…¸"
    var car: Car?
    
    deinit {
        print("person deinit")
    }
}

class Car {
    var model: String
    weak var lessee: Person?
    
    init(model: String) {
        self.model = model
    }
    
    deinit {
        print("car deinit")
    }
}

var person: Person? = Person()
var rentedCar: Car? = Car(model: "Porsche")

person?.car = rentedCar
rentedCar?.lessee = person // person ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì†Œìœ í•˜ì§€ì•Šê³  ì°¸ì¡° ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•˜ì§€ ì•ŠìŒ.

person = nil // ì°¸ì¡° ì¹´ìš´íŠ¸ 0 Strong Reference Cycle ì œê±° -> Person deinit í˜¸ì¶œ
rentedCar = nil // ì°¸ì¡° ì¹´ìš´íŠ¸ 0 Strong Reference Cycle ì œê±° -> Car deinit í˜¸ì¶œ

// Unowned Reference
class Person {
    var name = "John Doe"
    var car: Car?

    deinit {
        print("person deinit")
    }
}

class Car {
    var model: String
    unowned var lessee: Person // Optional ì°¨ì´

    init(model: String, lessee: Person) {
        self.model = model
        self.lessee = lessee
    }

    deinit {
        print("car deinit")
    }
}

var person: Person = Person()
var rentedCar: Car = Car(model: "Porsche", lessee: person)

person.car = rentedCar
rentedCar.lessee = person

//person = nil
//rentedCar = nil
```

### SRC with Closure Capture List
- Closureê°€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìº¡ì³í•˜ê³ , ì¸ìŠ¤í„´ìŠ¤ê°€ í´ë¡œì €ë¥¼ ê°•í•œ ì°¸ì¡°ë¡œ ì €ìž¥ì„ í•˜ê³  ìžˆë‹¤ë©´ ì¸ìŠ¤í„´ìŠ¤ê°€ í•´ì œë˜ì§€ ì•ŠìŒ
- Clouser ë‚´ì˜ SRCë¥¼ CCLë¡œ í•´ê²°í•  ìˆ˜ ìžˆìŒ
- CCLì˜ ê²½ìš° ì¶•ì•½ í˜•íƒœì—ì„œ in ìƒëžµ ë¶ˆê°€
- Reference Typeì„ ìº¡ì³í•  ë•ŒëŠ” ë°˜ë“œì‹œ weak, unowned ì¶”ê°€
- Value Typeì„ CCLì— ì¶”ê°€í•˜ë©´ ì°¸ì¡° ëŒ€ì‹  ë³µì‚¬ë³¸ì„ ìº¡ì³

```swift
class Car {
    var totalDrivingDistance = 0.0
    var totalUsedGas = 0.0
    
    lazy var gasMileage: () -> Double = { [weak self] in
        guard let strongSelf = self else {
            return 0.0
        }
        return strongSelf.totalDrivingDistance / strongSelf.totalUsedGas
    }
    
    func drive() {
        self.totalDrivingDistance = 1200.0
        self.totalUsedGas = 73.0
    }
    
    deinit {
        print("car deinit")
    }
}

var myCar: Car? = Car()
myCar?.drive()

myCar?.gasMileage()
myCar = nil

// Value Type
var a = 0
var b = 0
let c = { [a] in
    print(a, b)
}

a = 1 // 0 ê°’ íƒ€ìž…ì„ Closure Capture Listì— ì¶”ê°€í•˜ë©´ ì°¸ì¡°ëŒ€ì‹  ë³µì‚¬ë³¸ì„ ìº¡ì³í•¨.
b = 2
c()
```
---

> - ì°¸ê³ 
>   - [Automatic Reference Counting](https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html)
>   - [Transitioning to ARC Release Notes](https://developer.apple.com/library/archive/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html)
>   - [Automatic Reference Counting ì •ë¦¬](https://minsone.github.io/mac/ios/swift-automatic-reference-counting-summary)
